<!DOCTYPE html>
<html lang="en">
<head>
    <title>Web Share</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffcc00">

    <link rel="stylesheet" href="./style.css">

    <script type="module">
        const serviceWorkerSupported = "serviceWorker" in navigator;
        const isSecureHost = location.protocol === "https:" || location.hostname === "127.0.0.1" || location.hostname === "localhost";

        if(!isSecureHost) {
            document.querySelector("#https-note").classList.remove("hidden");
        }

        if (serviceWorkerSupported) {
            console.log("Registering of service worker");
            navigator.serviceWorker
                .register("./service-worker.js")
                .then(_ => {
                    document.querySelector("#sw-reg-note").classList.remove("hidden");
                    console.log("Service worker was registered");
                });

            //navigator.serviceWorker.addEventListener("message", message => console.log(message));

        } else {
            document.querySelector("#sw-note").classList.remove("hidden");
        }


        let deferredPrompt;
        function installPromptHandler() {
            window.addEventListener("beforeinstallprompt", event => {
                event.preventDefault();
                deferredPrompt = event;
                showInstallPromotion();
            }, {once: true});
        }
        function showInstallPromotion() {
            const installButton = document.querySelector("#install-pwa-button");
            installButton.classList.remove("hidden");
            installButton.addEventListener("click", async event => {
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                if (choiceResult.outcome === "accepted") {
                    console.log("User accepted the install prompt");
                    installButton.classList.add("hidden");
                } else {
                    console.log("User dismissed the install prompt");
                    installPromptHandler();
                }
            }, {once: true})
        }
        installPromptHandler();

    </script>

    <script type="module">
        const shareSupported = "share" in navigator;

        if(shareSupported) {
            const shareButton = document.querySelector("#share-button");
            const text = "Qwerty: https://example.com/";

            const file = new File([new Uint8Array([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A])], "0asd123.png", {type: "image/png"});
            const shareData = {
                text,
                files: [file]
            };

            checkCanShare(shareData);

            shareButton.addEventListener("click", async event => {
                event.preventDefault();

                const resultElem = document.querySelector("#result");
                try {
                    await navigator.share(shareData);
                    resultElem.textContent = "`navigator.share` succeeded.";
                } catch (error) {
                    const msg = "`navigator.share` failed";
                    resultElem.textContent = `${msg}\n${JSON.stringify(err)}`;
                }

            });
        } else {
            document.querySelector("#share-note").classList.remove("hidden");
            document.querySelector("#share-button").setAttribute("disabled", "");
        }

        function checkCanShare(data) {
            if (!navigator?.canShare(data)) {
                const canShareElem = document.querySelector("#can-share");
                canShareElem.classList.remove("hidden");
                canShareElem.textContent += JSON.stringify(data);
            }
        }

    </script>
</head>
<body>
    <h1>Web Share API demo</h1>

    <p id="https-note" class="hidden warning">This page requires to be served over HTTPS.</p>
    <p id="sw-note" class="hidden warning">Service worker is not supported.</p>
    <p id="sw-reg-note" class="hidden">Service worker was registered.</p>
    <p id="share-note" class="hidden warning">Web Share API is not supported.</p>
    <p id="can-share" class="hidden warning">Impossible to share this object: </p>

    <button id="share-button">Share</button>
    <button id="install-pwa-button" class="hidden">Install as PWA</button>

    <div id="result"></div>
</body>
</html>
